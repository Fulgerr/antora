name: Build and Deploy Antora Site

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Triggers the workflow on push events but only for the "main" branch
  push:
    branches:
      - main # Adjust if your main branch is named differently (e.g., master)

# Sets permissions for the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Defines a single job called "build-and-deploy"
jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest # Use a GitHub-hosted runner

    environment: # Optional: specify a GitHub Pages environment if you have one set up
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. Checkout your repository's code so the job can access it
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js, as Antora is a Node.js application
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Using Node.js version 18. You can adjust if needed.
          cache: 'npm' # Cache npm dependencies to speed up subsequent builds

      # 3. Install Antora CLI and the default site generator globally
      #    If Antora is part of your project's package.json, you might use 'npm ci' here instead.
      - name: Install Antora CLI and Site Generator
        run: npm install -g @antora/cli @antora/site-generator-default

      # 4. Run Antora to build your site using your playbook
      #    This assumes 'antora-playbook.yml' is in the root of your repository.
      - name: Build Antora site
        run: antora antora-playbook.yml

      # 5. Upload the generated site artifact for GitHub Pages
      #    This path MUST match Antora's output directory, which you confirmed is 'public'.
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      # 6. Deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4